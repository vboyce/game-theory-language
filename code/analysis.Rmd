---
title: "Game Theory"
output:
  html_document: 
    toc: true
---

# TODO
- for less munging, put player role into round
- put players increment into record!

- Raise the stakes (game length / pay / bonus)

Next pilot 
- second page of instructions about bonus v base pay
- 40 trials (~15 minutes) aim for $3-4 bonus 
- can you have a get to know you at the beginning for 30-60 seconds? 
- switch to stag hunt? or other coord game (BoS)

- switch to BoS -- what are payoffs? (A,B; 0,0)

# Pre-process

```{r set-up, include=F}
knitr::opts_chunk$set(echo = FALSE, warning=F, message=F)
knitr::opts_chunk$set(dev = "png", dev.args = list(type = "cairo-png"))
options(knitr.table.format = "html")
library(tidyverse)
library(jsonlite)
library(here)
library(rlang)
library(lme4)
library(brms)
library(rstan)
library(viridis)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
theme_set(theme_bw())

ParseJSONColumn <- function(x) {
  str_c("[ ", str_c(x, collapse = ",", sep=" "), " ]")  %>% 
    fromJSON(flatten = T)
}

##Data import constants
data_location="data/pilot211108"


date_start=lubridate::ymd('2021-11-08')

#image_location="write-ups/images"

#model_location="code/models"
```

```{r bonus}
##This was for determining participant bonuses using the version of data with PID

# d.players <- read_csv(here(data_location, 'players.csv')) %>% 
#   rename(playerId=`_id`) %>%
#   select(data.bonus, playerId,id) %>% 
#   mutate(bonus=round(data.bonus,2),
#          bonus=bonus %|% 0,
#          cost=round(5.33+bonus*4/3,2)) %>% 
#   write_csv(here(data_location, "player_payments.csv")) %>% select(id,bonus) %>% write_csv(here(data_location,"for_prolific.csv"))

```


```{r, include=F, eval=F}

d.games <- read_csv(here(data_location, 'games.csv')) %>% 
  rename(gameId = `_id`) %>% 
    filter(createdAt >= date_start)

d.players <- read_csv(here(data_location, 'players.csv')) %>% 
  select(playerId=`_id`,role=data.role)

d.chat.raw <- read_csv(here(data_location, 'rounds.csv'), guess_max=10000) %>%
  filter(createdAt >= date_start) %>%
  mutate(data.chat = ifelse(is.na(data.chat), '{}', data.chat)) %>%
  rename(row_id = `_id`) %>%
  mutate(data.chat = map(data.chat, .f = ParseJSONColumn)) %>%
  unnest(data.chat) %>% 
  select( -ends_with('response'), -ends_with('time')) %>%
  rename_with(~ gsub("data.", "", .x, fixed = TRUE)) %>% 
  write_csv(here(data_location, 'raw_chat.csv'))

d.round_results.raw <- read_csv(here(data_location,'rounds.csv'),guess_max=10000) %>% 
  filter(createdAt >= date_start) %>% 
  rename_with(~ gsub("data.", "", .x, fixed = TRUE)) %>% 
  rename_with ( ~ gsub("room", "player", .x, fixed=T)) %>% 
    rename_with ( ~ gsub("player", "player_", .x, fixed=T)) %>% 
    rename_with ( ~ gsub("response", "_response", .x, fixed=T)) %>% 
  rename_with( ~ gsub("time", "_time", .x, fixed=T)) %>% 
  select(-chat) %>% 
  gather(key, value, starts_with('player')) %>% 
  separate(key, into = c('blah', 'playerId', 'info')) %>% 
  spread(info, value) %>% 
  select(-blah) %>% 
  select(-stageIds,-index,-createdAt,-submitted) %>% 
  filter(!is.na(response)) %>% 
  mutate(time=as.numeric(time)/1000) %>% 
  mutate(targets=map(targets, .f=ParseJSONColumn)) %>% 
  unnest(targets) %>% 
  mutate(image = gsub('/experiment/', '', image, fixed=TRUE),
        image = gsub('.jpeg', '', image, fixed=TRUE)) %>% 
  pivot_wider(names_from=label, names_prefix="box_", values_from=image) %>% 
    mutate(payoffs=map(payoffs, .f=ParseJSONColumn)) %>%
  unnest(payoffs) %>% 
  left_join(d.players) %>% 
  mutate(AA=ifelse(role=="p1", AA.p1, AA.p2),
         AB=ifelse(role=="p1", AB.p1, AB.p2),
         BA=ifelse(role=="p1", BA.p1, BA.p2),
         BB=ifelse(role=="p1", BB.p1, BB.p2)) %>% 
  write_csv(here(data_location, 'raw_results.csv'))

d.exit.survey <- read_csv(here(data_location, 'player-inputs.csv')) %>%
  filter(createdAt >= date_start) %>%
  left_join(d.games, by = c('gameId')) %>%
    rename_with(~ gsub("data.", "", .x, fixed = TRUE)) %>% 
  write_csv(here(data_location,'exit.csv'))



```

# Metrics
Paid $4 based on 20 minutes (including instructions, waiting, game, and end survey). 

Welp, people definitely took the "click through" approach ...

```{r}
d.round_results <- read_csv(here(data_location,"raw_results.csv"))

summary <- d.round_results %>% group_by(repNum, gameId) %>% 
           mutate(time= time %|% 180) %>% 
  summarize(max_time=max(time)) %>% 
  group_by(gameId) %>% 
  summarize(total_time=sum(max_time)/60,
            num_rounds=max(repNum))

summary

```

```{r}
pairs <- d.round_results %>% select(playerId,gameId) %>% unique()
d.players <- read_csv(here(data_location, 'players.csv')) %>% select(playerId=`_id`,data.bonus) %>% filter(!is.na(data.bonus)) %>% left_join(pairs) %>% arrange(gameId)

d.players
```

Not much talking, mostly one person

```{r}
chat <- read_csv(here(data_location, "raw_chat.csv")) %>% filter(!is.na(text))

chat %>% select(gameId,playerId,repNum,text)

```

# What do people choose

win > coop > defect > 0
   "AA":{p1:coop,p2:coop},
   "AB":{p1:0,p2:win},
   "BA":{p1:win,p2:0},
   "BB":{p1:defect,p2:defect}

```{r}
outcome <- d.round_results %>% select(gameId:repNum, response,role) %>% 
  pivot_wider(names_from=role, values_from=response) %>% 
  mutate(outcome=str_c(p1,p2))

ggplot(outcome, aes(x=repNum, y=outcome, color=gameId))+geom_jitter(height=.1)

```

# What do they say about the game

```{r}
  comments <- read_csv(here(data_location,'exit.csv')) %>% select(playerId, gameId, human, workedWell, fair, chatUseful) %>% filter(!is.na(gameId)) %>% arrange(gameId)

comments %>% select(playerId, human, workedWell)

comments %>% select(playerId,fair)

comments %>% select(playerId, chatUseful)

```
